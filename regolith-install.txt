# Register the Regolith public key to your local apt
curl -s https://archive.regolith-desktop.com/regolith.key | gpg --dearmor | sudo tee /usr/share/keyrings/regolith-archive-keyring.gpg > /dev/null

# Add the repository URL to your local apt
echo deb "[arch=amd64 signed-by=/usr/share/keyrings/regolith-archive-keyring.gpg] https://archive.regolith-desktop.com/ubuntu/stable noble v3.3" | \
sudo tee /etc/apt/sources.list.d/regolith.list

# system udpate via apt
sudo apt update && sudo apt dist-upgrade -y

### install regolith
sudo apt install -y lightdm
sudo apt install -y regolith-desktop
sudo apt remove -y gdm3
sudo apt install -y regolith-session-flashback regolith-look-blackhole
sudo apt install -y regolith-system-ubuntu 
sudo apt remove -y zutty

### allow networking via applet
sudo apt install -y regolith-wm-networkmanager
sudo systemctl disable systemd-networkd-wait-online.service && sudo systemctl mask systemd-networkd-wait-online.service
printf "network:\n  version: 2\n  renderer: NetworkManager\n" | sudo tee /etc/netplan/50-cloud-init.yaml
sudo chmod og-rwx /etc/netplan/50-cloud-init.yaml

### regolith customizations
sudo apt install -y i3xrocks-battery
mkdir -p ~/.config/regolith3/i3xrocks/conf.d/
printf 'command=/usr/share/i3xrocks/scripts/$BLOCK_NAME\nseparator_block_width=35\nmarkup=pango\ncolor=xresource:i3xrocks.value.color\nlabel_color=xresource:i3xrocks.label.color\n' > ~/.config/regolith3/i3xrocks/conf.d/01_setup
printf "[battery]\ninterval=10\n" > ~/.config/regolith3/i3xrocks/conf.d/80_battery
printf "[time]\ncommand=date '+%%Y-%%m-%%d %%H:%%M:%%S'\ninterval=5\n" > ~/.config/regolith3/i3xrocks/conf.d/99_custom


### shell personalization - zsh + oh my zsh
if [ -f "$HOME/.zshrc" ]; then
    echo "~/.zshrc already exists - skipping zsh and oh-my-zsh step"
else
    sudo apt install -y zsh
    sudo chsh -s $(which zsh) $(whoami)
    echo "n" | ZSH= sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
    printf "\nbindkey -v\nbindkey '^R' history-incremental-search-backward\n" >> ~/.zshrc
fi

### add some software through apt and snap
sudo apt install -y firefox kicad unzip make gcc ripgrep unzip git xclip
sudo snap install freecad
sudo snap install mailspring
sudo snap install nvim --classic

### add nvm and install node 22+
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
nvm install node 22

### setup kickstart.nvim
if [ -d "~/.config/nvim/" ]; then
    echo "~/.config/nvim/ already exists, updating"
    cd ~/.config/nvim && git pull
else
    echo "setting up kickstart.nvim into ~/.config/nvim"
    git clone https://github.com/rhhayward/kickstart.nvim.git ~/.config/nvim/
fi


### add arduino from zip file, add desktop file
if [ -d "/opt/Arduino/" ]; then
    echo "/opt/Arduino/ already exists - skipping Arduino install step"
else
    sudo usermod -a -G dialout $(whoami)
    sudo mkdir /opt/Arduino/
    curl https://downloads.arduino.cc/arduino-ide/arduino-ide_2.3.6_Linux_64bit.zip -o /tmp/arduino-ide-2.zip
    sudo unzip /tmp/arduino-ide-2.zip -d /opt/Arduino/
    sudo chown root:root /opt/Arduino/arduino-ide_2.3.6_Linux_64bit/chrome-sandbox
    sudo chmod 4755 /opt/Arduino/arduino-ide_2.3.6_Linux_64bit/chrome-sandbox
    sudo curl -o /opt/Arduino/arduino-ide.png https://i.sstatic.net/HbDAj.png
    printf "[Desktop Entry]\nExec=/opt/Arduino/arduino-ide_2.3.6_Linux_64bit/arduino-ide\nIcon=/opt/Arduino/arduino-ide.png\nName[en_US]=Arduino IDE\nName=Arduino IDE\nPath=\nStartupNotify=false\nTerminal=false\nType=Application\n" | sudo tee /opt/Arduino/arduino-ide.desktop > /dev/null
    sudo ln -s /opt/Arduino/arduino-ide.desktop /usr/share/applications/
    rm /tmp/arduino-ide-2.zip
fi

sudo apt autoremove -y && sudo apt autoclean -y

### setup dconf settings - primarily to make gnome-terminal readable to old eyes
echo H4sIAAAAAAAAA71UyW7bMBC98ysE9MAECCPJ8hpAQNKmvbUo2qPhA0WNFpgiBS5u3a/vSJaX2GnqXirBBvVm+DgzfDNLbcqwVLqBMAe7droNMy7WpdFe5SvS1sJ5A0y3rtbKpvSX1g09wN7UKS1qCQ9hGHprQltxAycMNjRQalm7imUS0UpLYJv4PsK3VSUlZHkZQK1a75jV3giwKyK8MaBc6mvlklEQkcGSLm/oz3VG7wLqLb1dEfw4BPrIbbBc/YHegSm4gBXJtfANcrNC45/iDaT0O1c2iCNKXmBewAedw1ejgy9g8uATGoPPWukgjikp3Zq5CjrXp61nz9ysKamFVgfUCEoadLctHsyupF68Xh8rDICyfAPmP98QbLT03Tks544zC6aPoalLwx3kqTMeXmzASje14jKUUHKxxYpDwb3E2630D4al9xk3acGlBVIBz8F0349NFuywN7jC1uguMftwYE3pvEiSUZLELJokBRtHImNZNMlZNuJiOoVZHEUzSmRtXbq8znl1XQzhwzVsK8J9XmdY4QykHPI+3gUTWmqTUlNmN9Edvrf01OoMSrPF61Niy1rAHsCuGJNMy8POd7Mkj4qCnoDMos4Yt6wo9wd2ttqyzNRl5QYQu8yi82Uw72AKsUDKvYes1Zo1qNiU6uKI9+4WNeF2MhjgQqO+XhIWWKkk2TXYX3pr2nmdE3TlGU0md8MPi1RhIrJL5q34j07noR4tr0Qb9Q8lSpuc9SpgexUwVL/FbkhpdI8dg13HJTgHqK39NhxO+3y7ZcZhOoMBzSfzncNwaT06ms9mi365mMBU9ONtn8LZ8l9434/nH5+ez3mL/kGN40jRUmLvsRZngdimVAEmR4m3wOzWOmj6oTWIpUP7yXZS7wvTrsoX8KmKT40H2F2Sbmrbd81uZH4bBha9tjX5aByNBB+xPFpwNh6PBfbflLOY87ko8iKK+WJ11QW/kfhvEYRkskoHAAA= | base64 -d | gunzip - | dconf load /

### set terminal, firefox, mailspring to start on login
mkdir -p ~/.config/regolith3/i3/config.d/
echo IyMjIHNldHVwIHJ1bGVzIGJlZm9yZSBzdGFydGluZyBhcHBzCmZvcl93aW5kb3cgW2NsYXNzPSJHbm9tZS10ZXJtaW5hbCJdIG1vdmUgdG8gd29ya3NwYWNlIDEKZm9yX3dpbmRvdyBbY2xhc3M9ImZpcmVmb3hfZmlyZWZveCJdIG1vdmUgdG8gd29ya3NwYWNlIDIKZm9yX3dpbmRvdyBbY2xhc3M9Ik1haWxzcHJpbmciXSBtb3ZlIHRvIHdvcmtzcGFjZSAzCgojIyMgc3RhcnQgYXBwcwpleGVjIC0tbm8tc3RhcnR1cC1pZCBnbm9tZS10ZXJtaW5hbApleGVjIC0tbm8tc3RhcnR1cC1pZCBmaXJlZm94CmV4ZWMgLS1uby1zdGFydHVwLWlkIG1haWxzcHJpbmcKCiMjIyB0b2dnbGUgdGhyb3VnaCB3b3Jrc3BhY2VzIHRvIGNsZWFyIG9yYW5nZSBiYWRnZXMKZXhlYyAic2xlZXAgNSA7IGkzLW1zZyAnd29ya3NwYWNlIDEnIDsgaTMtbXNnICd3b3Jrc3BhY2UgMicgOyBpMy1tc2cgJ3dvcmtzcGFjZSAzJyA7IGkzLW1zZyAnd29ya3NwYWNlIDEnIgo= | base64 -d > ~/.config/regolith3/i3/config.d/99_custom

sudo reboot
